<!DOCTYPE html>

<html lang="en">
<head>
  <title>EFM Web App</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<!-- Header -->

<div class="container-fluid p-2 bg-primary text-white text-center">
  <h1>EFM WEB APP</h1>
</div>

<!-- Navigation -->

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <div class="container-fluid">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="index.html">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="stats.html">Stats</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Section Title -->

<div class="container-fluid pt-2 pb-2 ps-2 bg-light bg-gradient">
  <h2>Active Flights</h2>
</div>

<div class="container mt-2">

  <!-- Auto refresh info -->

  <div class="alert alert-info py-2 mb-2">
    Auto-refreshing every <strong>60 seconds</strong>
  </div>

  <!-- Loading spinner -->

  <div id="loadingSpinner" class="text-center my-3">
    <div class="spinner-border text-primary" role="status"></div>
    <div>Loading flights...</div>
  </div>

  <!-- Flights table -->

  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th>AIRCRAFT</th>
        <th>FROM</th>
        <th>TO</th>
        <th>ETA</th>
      </tr>
    </thead>
    <tbody id="flightsTableBody">
      <!-- Dynamic rows -->
    </tbody>
  </table>

</div>

<script>
  const apiUrl = "https://q97yj6cmpe.execute-api.eu-west-2.amazonaws.com/EFM_API/get_all_flights";
  const tableBody = document.getElementById("flightsTableBody");
  const spinner = document.getElementById("loadingSpinner");

  function fetchFlights() {
    spinner.style.display = "block";

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        tableBody.innerHTML = "";

        // Sort by ETA FULL (earliest first)
        data.sort((a, b) => new Date(a["ETA FULL"]) - new Date(b["ETA FULL"]));

        const now = new Date();

        data.forEach(flight => {
          const eta = new Date(flight["ETA FULL"]);
          const isOverdue = eta < now;

          const row = document.createElement("tr");

          // Highlight overdue flights
          if (isOverdue) {
            row.classList.add("table-danger");
          }

          row.innerHTML = `
            <td>${flight["Aircraft"]}</td>
            <td>${flight["From"]}</td>
            <td>${flight["To"]}</td>
            <td>
              ${flight["ETA Abbreviated"]}
              ${isOverdue ? '<span class="badge bg-danger ms-2">OVERDUE</span>' : ''}
            </td>
          `;

          tableBody.appendChild(row);
        });

        spinner.style.display = "none";
      })
      .catch(error => {
        spinner.style.display = "none";
        console.error("Error fetching flights:", error);

        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-danger">
              Failed to load flight data
            </td>
          </tr>
        `;
      });
  }

  // Initial load
  fetchFlights();

  // Auto-refresh every 60 seconds
  setInterval(fetchFlights, 60000);
</script>

</body>
</html>