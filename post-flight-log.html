<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Post Flight Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">

  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <style>

      body {
    background: linear-gradient(180deg, #d8d9db 100%,#d8d9db 100%);
    }


    body.loading { cursor: wait; }


    .fade-in { opacity: 0; transform: translateY(4px); transition: opacity .25s ease, transform .25s ease; }
    .fade-in.ready { opacity: 1; transform: translateY(0); }

    .skeleton {
      height: 38px;
      border-radius: 0.375rem;
      background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 37%, #e9ecef 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Section styling: subtle contrast */
      .section-card {
      border: 1px solid #abadb1;
      border-radius: 1rem;
      background: #929396;
      box-shadow:
        0 1px 2px rgba(0,0,0,0.04),
        0 6px 20px rgba(0,0,0,0.06);
    }

      .section-card:hover {
      box-shadow:
        0 4px 10px rgba(0,0,0,0.08),
        0 12px 28px rgba(0,0,0,0.08);
    }
      
        .section-card .card-header {
      background: linear-gradient(180deg, #f8f9fa, #f1f3f5);
      border-bottom: 1px solid #dee2e6;
      font-weight: 700;
      letter-spacing: 0.2px;
      padding: 0.75rem 1rem;
    }

        .section-card .card-header::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 100%;
      margin-right: 0.75rem;
      background: #0d6efd;
      border-radius: 3px;
      vertical-align: middle;
    }

    .form-control,
    .form-select {
      border-radius: 0.6rem;
      border-color: #dee2e6;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.15rem rgba(13,110,253,.15);
    }


    .section-card.alt { background: #ffffff; }
    .form-label { font-weight: 600; }

    /* Tacho widget */
    .tacho {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      background: #f8f9fa;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .tacho-digit {
      width: 2.1rem;
      height: 2.3rem;
      text-align: center;
      font-weight: 800;
      font-size: 1.1rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      background: #000;
      color: #fff;
      padding: 0;
    }

  .tacho-digit {
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

    .tacho-digit:focus {
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
      border-color: #86b7fe;
    }

    .tacho-dot {
      font-weight: 900;
      font-size: 1.2rem;
      padding: 0 0.1rem;
      color: #212529;
    }

    .tacho.invalid {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.15rem rgba(220,53,69,.15);
    }

      .alert {
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
  </style>

 
</head>

<body>
  <div id="navbar-placeholder"></div>

  <div class="alert alert-warning">
  <strong>Warning</strong> Test Mode Only - feel free to experiment!
</div>

  <main class="container my-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <h1 class="h3 mb-0">Post Flight Log</h1>
        <div class="text-muted small">Complete your flight and file the log.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="my-bookings.html">Back</a>
        <button id="submitBtnTop" class="btn btn-primary" type="submit" form="flightLogForm">Submit Log</button>
      </div>
    </div>

    <!-- Skeleton while booking prefill loads -->
    <div id="prefillSkeleton" class="card section-card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
        </div>
      </div>
    </div>

    <form id="flightLogForm" class="fade-in" novalidate>
      <!-- Flight details -->
      <div class="card section-card alt mb-3">
        <div class="card-header">Flight details</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="picName">PIC Name</label>
              <input class="form-control" id="picName" name="picName" type="text" required>
              <div class="invalid-feedback">PIC Name is required.</div>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="flightDate">Date</label>
              <input class="form-control" id="flightDate" name="flightDate" type="date" required>
              <div class="invalid-feedback">Date is required.</div>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="aircraft">Aircraft</label>
              <input class="form-control" id="aircraft" name="aircraft" type="text" required>
              <div class="invalid-feedback">Aircraft is required.</div>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="from">From</label>
              <input class="form-control" id="from" name="from" type="text" required>
              <div class="invalid-feedback">From is required.</div>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="to">To</label>
              <input class="form-control" id="to" name="to" type="text" required>
              <div class="invalid-feedback">To is required.</div>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="authorised">Authorised</label>
              <input class="form-control" id="authorised" name="authorised" type="text">
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" for="p2">P2</label>
              <input class="form-control" id="p2" name="p2" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p3">P3</label>
              <input class="form-control" id="p3" name="p3" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p4">P4</label>
              <input class="form-control" id="p4" name="p4" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="instructional">Instructional flight?</label>
              <select class="form-select" id="instructional" name="instructional">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Times + tacho -->
      <div class="card section-card alt mb-3">
        <div class="card-header">Times</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="offChocks">Off chocks</label>
              <input class="form-control" id="offChocks" name="offChocks" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="takeoff">Takeoff</label>
              <input class="form-control" id="takeoff" name="takeoff" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="land">Land</label>
              <input class="form-control" id="land" name="land" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="onChocks">On chocks</label>
              <input class="form-control" id="onChocks" name="onChocks" type="time" step="300">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-12 col-md-6">
              <label class="form-label" for="blockTime">Block time (auto)</label>
              <input class="form-control" id="blockTime" type="text" readonly placeholder="--:--">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="airTime">Air time (auto)</label>
              <input class="form-control" id="airTime" type="text" readonly placeholder="--:--">
            </div>
            <div class="col-12">
              <div class="form-text" id="timeHelp">
                Times auto-calculate once all four fields are complete (snaps to nearest 5 minutes).
              </div>
            </div>
          </div>

          <hr class="my-3">

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Start tacho<span class="text-danger">*</span></label>
              <div class="tacho" data-tacho="start">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 1">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 2">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 3">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 4">
                <span class="tacho-dot" aria-hidden="true">.</span>
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho decimal digit">
              </div>
              <input type="hidden" id="startTacho" name="startTacho" value="">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">End tacho <span class="text-danger">*</span></label>
              <div class="tacho" data-tacho="end">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 1">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 2">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 3">
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 4">
                <span class="tacho-dot" aria-hidden="true">.</span>
                <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho decimal digit">
              </div>
              <input type="hidden" id="endTacho" name="endTacho" value="">
              <div class="form-text">End tacho is mandatory.</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="tachoDiff">Tacho difference (auto)</label>
              <input class="form-control" id="tachoDiff" type="text" readonly placeholder="--.-">
              <div class="form-text">Shown as hours.tenths (e.g. 1.7).</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fuel & oil -->
      <div class="card section-card alt mb-3">
        <div class="card-header">Fuel & oil</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedLfc">Fuel uplifted at LFC (litres)</label>
              <input class="form-control" id="fuelUpliftedLfc" name="fuelUpliftedLfc" type="number" step="0.1" min="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelRemaining">Remaining fuel</label>
              <input class="form-control" id="fuelRemaining" name="fuelRemaining" type="text" placeholder="e.g. Tabs / litres">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedElsewhere">Fuel uplifted elsewhere (litres)</label>
              <input class="form-control" id="fuelUpliftedElsewhere" name="fuelUpliftedElsewhere" type="number" step="0.1" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelCost">Cost of fuel (£)</label>
              <input class="form-control" id="fuelCost" name="fuelCost" type="number" step="0.01" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="oilUploaded">Oil uploaded</label>
              <input class="form-control" id="oilUploaded" name="oilUploaded" type="text" placeholder="e.g. 1 litre">
            </div>
          </div>
        </div>
      </div>

      <!-- Landings & payment -->
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card section-card alt h-100">
            <div class="card-header">Landings</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="landingsKemble">Kemble total landings (inc T&amp;G / overshoots)</label>
                  <input class="form-control" id="landingsKemble" name="landingsKemble" type="number" step="1" min="0" value="0">
                </div>
                <div class="col-12">
                  <label class="form-label" for="landingsOther">T&amp;Gs and landings at other airfields</label>
                  <input class="form-control" id="landingsOther" name="landingsOther" type="number" step="1" min="0" value="0">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card section-card alt h-100">
            <div class="card-header">Payment</div>
            <div class="card-body">
              <div class="row g-3">
                
                 <div class="col-12 col-md-6">
                  <label class="form-label" for="paymentMethod">Who is paying for hire?</label>
                  <select class="form-select" id="paymentMethod" name="paymentMethod">
                    <option value="" selected>Choose…</option>
                    <option>PIC</option>
                    <option>P2</option>
                    <option>Club</option>
                    <option>Owner</option>
                  </select>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="paymentMethod">Payment method</label>
                  <select class="form-select" id="paymentMethod" name="paymentMethod">
                    <option value="" selected>Choose…</option>
                    <option>Card</option>
                    <option>Cash</option>
                    <option>Account</option>
                    <option>Other</option>
                  </select>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="tempMember">Temp member?</label>
                  <select class="form-select" id="tempMember" name="tempMember">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="maintenanceTrip">Maintenance trip?</label>
                  <select class="form-select" id="maintenanceTrip" name="maintenanceTrip">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="rescueFlight">Rescue flight?</label>
                  <select class="form-select" id="rescueFlight" name="rescueFlight">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmation + submit -->
      <div class="card section-card alt mt-3">
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="confirm" required>
            <label class="form-check-label" for="confirm">
              I confirm as pilot in command the information in this form is correct.
            </label>
            <div class="invalid-feedback">You must confirm before submitting.</div>
          </div>
          <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
            <a class="btn btn-outline-secondary" href="my-bookings.html">Cancel</a>
            <button id="submitBtn" class="btn btn-primary" type="submit">Submit Log</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="bookingId" name="bookingId" />
    </form>
  </main>

  <!-- Auth + shared helpers -->
  <script src="js/auth.js"></script>
  <script src="js/logout.js"></script>
  <script src="js/ui.js"></script>

  <script>
    // FlightBookings API base
    const API_BASE = "https://rj7w2wkpgj.execute-api.eu-west-2.amazonaws.com";

    const params = new URLSearchParams(window.location.search);
    const bookingId = params.get("id");

    const prefillSkeleton = document.getElementById("prefillSkeleton");
    const form = document.getElementById("flightLogForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitBtnTop = document.getElementById("submitBtnTop");

    function setPrefillVisible(isReady) {
      if (!prefillSkeleton || !form) return;
      prefillSkeleton.classList.toggle("d-none", isReady);
      form.classList.toggle("ready", isReady);
    }

    function toISODateFromEta(eta) {
      if (!eta) return null;
      const s = String(eta).replace(" ", "T");
      const d = s.split("T")[0];
      return /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : null;
    }

    // ---------- Times logic (single source of truth) ----------
    const TIME_IDS = ["offChocks", "takeoff", "land", "onChocks"];

    function parseHHMM(v) {
      if (!v || !/^\d{2}:\d{2}$/.test(v)) return null;
      const [hh, mm] = v.split(":").map(Number);
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
      return hh * 60 + mm;
    }

    function minutesToHHMM(mins) {
      const hh = Math.floor(mins / 60);
      const mm = mins % 60;
      return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
    }

    function snapMinutesTo5(mins) {
      return Math.round(mins / 5) * 5;
    }

    function duration(start, end) {
      let d = end - start;
      if (d < 0) d += 24 * 60;
      return d;
    }

    function allTimesPresent() {
      return TIME_IDS.every(id => {
        const v = document.getElementById(id)?.value;
        return v && /^\d{2}:\d{2}$/.test(v);
      });
    }

    function clearInvalidTimes() {
      TIME_IDS.forEach(id => document.getElementById(id)?.classList.remove("is-invalid"));
    }

    function setInvalidTimes(flag) {
      TIME_IDS.forEach(id => document.getElementById(id)?.classList.toggle("is-invalid", flag));
    }

    function validateAndCalcTimes() {
      if (!allTimesPresent()) {
        clearInvalidTimes();
        document.getElementById("blockTime").value = "";
        document.getElementById("airTime").value = "";
        return;
      }

      const offEl = document.getElementById("offChocks");
      const toEl = document.getElementById("takeoff");
      const landEl = document.getElementById("land");
      const onEl = document.getElementById("onChocks");

      const off = parseHHMM(offEl.value);
      const to = parseHHMM(toEl.value);
      const land = parseHHMM(landEl.value);
      const on = parseHHMM(onEl.value);

      const snapped = {
        off: snapMinutesTo5(off),
        to: snapMinutesTo5(to),
        land: snapMinutesTo5(land),
        on: snapMinutesTo5(on)
      };

      offEl.value = minutesToHHMM(snapped.off);
      toEl.value = minutesToHHMM(snapped.to);
      landEl.value = minutesToHHMM(snapped.land);
      onEl.value = minutesToHHMM(snapped.on);

      const block = duration(snapped.off, snapped.on);
      const air = duration(snapped.to, snapped.land);

      let invalid = false;
      if (air > block) invalid = true;
      if (block <= 0) invalid = true;
      if (block > 16 * 60) invalid = true;

      const taxiOut = duration(snapped.off, snapped.to);
      const taxiIn = duration(snapped.land, snapped.on);
      if (taxiOut > 6 * 60 || taxiIn > 6 * 60) invalid = true;

      setInvalidTimes(invalid);

      if (invalid) {
        document.getElementById("blockTime").value = "";
        document.getElementById("airTime").value = "";
        if (typeof showToast === "function") {
          showToast("Check time order: Off chocks → Takeoff → Land → On chocks", { variant: "danger" });
        }
        return false;
      }

      document.getElementById("blockTime").value = minutesToHHMM(block);
      document.getElementById("airTime").value = minutesToHHMM(air);
      return true;
    }

    TIME_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", validateAndCalcTimes);
      el.addEventListener("blur", validateAndCalcTimes);
    });

    // ---------- Tacho logic ----------
    function clampDigitChar(ch) {
      return /[0-9]/.test(ch) ? ch : "";
    }

    function getDigits(container) {
      return Array.from(container.querySelectorAll(".tacho-digit"));
    }

    function buildTachoString(container) {
      const digits = getDigits(container).map(i => (i.value || "0"));
      return `${digits[0]}${digits[1]}${digits[2]}${digits[3]}.${digits[4]}`;
    }

    function isComplete(container) {
      return getDigits(container).every(i => /^[0-9]$/.test(i.value));
    }

    function tachoToTenths(tachoStr) {
      if (!/^\d{4}\.\d$/.test(tachoStr)) return null;
      const whole = parseInt(tachoStr.slice(0, 4), 10);
      const tenth = parseInt(tachoStr.slice(5, 6), 10);
      if (Number.isNaN(whole) || Number.isNaN(tenth)) return null;
      return whole * 10 + tenth;
    }

    function tenthsToHoursTenths(tenths) {
      const hours = Math.floor(tenths / 10);
      const t = tenths % 10;
      return `${hours}.${t}`;
    }

    function syncHidden(container) {
      const kind = container.getAttribute("data-tacho");
      const hidden = document.getElementById(kind === "start" ? "startTacho" : "endTacho");
      if (!hidden) return;

      hidden.value = isComplete(container) ? buildTachoString(container) : "";
    }

    function validateAndCalcTacho() {
      const startBox = document.querySelector('.tacho[data-tacho="start"]');
      const endBox = document.querySelector('.tacho[data-tacho="end"]');
      const diffOut = document.getElementById("tachoDiff");

      if (!startBox || !endBox) return true;

      // Only validate once BOTH are complete
      if (!isComplete(startBox) || !isComplete(endBox)) {
        startBox.classList.remove("invalid");
        endBox.classList.remove("invalid");
        diffOut.value = "";
        return true;
      }

      const startT = tachoToTenths(buildTachoString(startBox));
      const endT = tachoToTenths(buildTachoString(endBox));

      const invalid = (startT == null || endT == null || endT < startT);

      startBox.classList.toggle("invalid", invalid);
      endBox.classList.toggle("invalid", invalid);

      if (invalid) {
        diffOut.value = "";
        if (typeof showToast === "function") {
          showToast("End tacho must be greater than or equal to start tacho.", { variant: "danger" });
        }
        return false;
      }

      const diffTenths = endT - startT;
      diffOut.value = tenthsToHoursTenths(diffTenths);
      return true;
    }

    function wireTacho(container) {
      const inputs = getDigits(container);

      inputs.forEach((input, idx) => {
        input.setAttribute("autocomplete", "off");
        input.setAttribute("pattern", "[0-9]*");

        input.addEventListener("input", () => {
          const v = clampDigitChar(input.value);
          input.value = v;

          if (v && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
            inputs[idx + 1].select?.();
          }

          syncHidden(container);
          validateAndCalcTacho();
        });

        input.addEventListener("keydown", (e) => {
          const key = e.key;

          if (key === "Backspace") {
            if (input.value) {
              input.value = "";
              e.preventDefault();
            } else if (idx > 0) {
              inputs[idx - 1].focus();
              inputs[idx - 1].value = "";
              e.preventDefault();
            }
            syncHidden(container);
            validateAndCalcTacho();
            return;
          }

          if (key === "ArrowLeft" && idx > 0) { inputs[idx - 1].focus(); e.preventDefault(); return; }
          if (key === "ArrowRight" && idx < inputs.length - 1) { inputs[idx + 1].focus(); e.preventDefault(); return; }

          if (key.length === 1 && !/[0-9]/.test(key)) e.preventDefault();
        });

        input.addEventListener("focus", () => input.select?.());

        input.addEventListener("blur", () => {
          syncHidden(container);
          validateAndCalcTacho();
        });
      });
    }

    function setTachoDigits(container, tachoStr) {
      if (!/^\d{4}\.\d$/.test(tachoStr)) return false;
      const digits = getDigits(container);
      const raw = tachoStr.replace(".", ""); // "01234"
      for (let i = 0; i < 5; i++) digits[i].value = raw[i];
      syncHidden(container);
      validateAndCalcTacho();
      return true;
    }

    async function prefillStartTachoFromLast(aircraft) {
      try {
        const res = await authFetch(`${API_BASE}/aircraft_tacho/${encodeURIComponent(aircraft)}`);
        if (!res || !res.ok) return;

        const data = await res.json();
        if (!data?.lastTacho) return;

        const startBox = document.querySelector('.tacho[data-tacho="start"]');
        if (!startBox) return;

        const digits = Array.from(startBox.querySelectorAll(".tacho-digit"));
        const userStarted = digits.some(d => (d.value || "").trim() !== "");
        if (userStarted) return;

        setTachoDigits(startBox, data.lastTacho);
      } catch (e) {
        console.warn("Could not prefill start tacho", e);
      }
    }

    // ---------- Prefill + submit ----------
    async function prefillFromBooking() {
      if (!bookingId) {
        showToast("Missing booking id", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      document.getElementById("bookingId").value = bookingId;

      const res = await authFetch(`${API_BASE}/get_booking/${encodeURIComponent(bookingId)}`);
      if (!res || !res.ok) {
        showToast("Failed to load booking for prefill", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      const b = await res.json();

      // Best-effort mapping
      document.getElementById("picName").value = b.picName || b.pic || b.PIC || localStorage.getItem("username") || "";
      document.getElementById("from").value = b.from ?? "";
      document.getElementById("to").value = b.to ?? "";
      document.getElementById("authorised").value = b.authorised ?? b.authorized ?? "";
      document.getElementById("aircraft").value = b.aircraft ?? "";

      // Date from booking ETA if available, otherwise today
      const etaDate = toISODateFromEta(b.eta);
      document.getElementById("flightDate").value = etaDate || new Date().toISOString().slice(0, 10);

      // P2–P4 from passengers array
      const pax = Array.isArray(b.passengers) ? b.passengers : [];
      document.getElementById("p2").value = pax[0]?.name || "";
      document.getElementById("p3").value = pax[1]?.name || "";
      document.getElementById("p4").value = pax[2]?.name || "";

      // Prefill start tacho from last known per aircraft
      if (b.aircraft) {
        await prefillStartTachoFromLast(b.aircraft);
      }

      setPrefillVisible(true);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Bootstrap validation
      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        showToast("Please complete the required fields", { variant: "warning" });
        return;
      }

      // End tacho mandatory (matches server-side)
      const endTacho = document.getElementById("endTacho")?.value || "";
      if (!/^\d{4}\.\d$/.test(endTacho)) {
        showToast("Please enter End tacho (4 digits + . + 1 digit)", { variant: "warning" });
        return;
      }

      // Validate times group (only meaningful if all four entered)
      const timesOk = validateAndCalcTimes();
      if (timesOk === false) return;

      // Validate tacho group (if both complete, must be ordered)
      const tachoOk = validateAndCalcTacho();
      if (tachoOk === false) return;

      const payload = Object.fromEntries(new FormData(form).entries());

      setButtonLoading(submitBtn, true, { loadingText: "Submitting…" });
      setButtonLoading(submitBtnTop, true, { loadingText: "Submitting…" });

      try {
        const res = await authFetch(`${API_BASE}/complete_booking/${encodeURIComponent(bookingId)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res || !res.ok) throw new Error(`Submit failed (${res?.status || "no response"})`);

        showToast("Flight log submitted", { variant: "success" });
        setTimeout(() => { window.location.href = "my-bookings.html"; }, 600);
      } catch (err) {
        console.error(err);
        showToast("There was a problem submitting the flight log.", { variant: "danger" });
      } finally {
        setButtonLoading(submitBtn, false);
        setButtonLoading(submitBtnTop, false);
      }
    });

    // Navbar
    fetch("/partials/navbar.html")
      .then(res => res.text())
      .then(html => {
        const mount = document.getElementById("navbar-placeholder");
        if (mount) mount.innerHTML = html;
        // Re-run logout wiring after injecting navbar
        const s = document.createElement("script");
        s.src = "js/logout.js";
        document.body.appendChild(s);
      })
      .catch(err => console.error("Navbar load failed", err));

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".tacho").forEach(wireTacho);
      withLoading(async () => {
        setPrefillVisible(false);
        await prefillFromBooking();
      });
    });
  </script>
</body>
</html>
