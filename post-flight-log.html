<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Post Flight Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <style>
    body.loading { cursor: wait; }

    .fade-in { opacity: 0; transform: translateY(4px); transition: opacity .25s ease, transform .25s ease; }
    .fade-in.ready { opacity: 1; transform: translateY(0); }

    .skeleton {
      height: 38px;
      border-radius: 0.375rem;
      background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 37%, #e9ecef 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Keep the layout tidy on phones */
    .section-card { border: 0; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
    .section-card .card-header { background: #646669; }
    .form-label { font-weight: 600; }
  </style>





    <style>
      /* Section container */
      .form-section {
        background-color: #8d8f91; /* light grey */
        border: 1px solid #14044d;
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
      }

      /* Alternate shade for visual rhythm */
      .form-section.alt {
        background-color: #b0b0e6;
      }

      /* Section header */
      .form-section h5 {
        font-weight: 600;
        margin-bottom: 1rem;
        color: #212529;
      }

      /* Slight elevation */
      .form-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      }

      .section-card.alt {
        background-color: #ffffff;
      }

      .tacho {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.35rem 0.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  background: #f8f9fa;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

.tacho-digit {
  width: 2.1rem;
  height: 2.3rem;
  text-align: center;
  font-weight: 700;
  font-size: 1.1rem;
  border-radius: 0.5rem;
  border: 1px solid #ced4da;
  background: #000;
  color: #fff;
  padding: 0;
}

.tacho-digit:focus {
  outline: none;
  box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
  border-color: #86b7fe;
}

.tacho-dot {
  font-weight: 800;
  font-size: 1.2rem;
  padding: 0 0.1rem;
  color: #212529;
}

.tacho.invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.15rem rgba(220,53,69,.15);
}

  </style>
  


</head>

<body>
  <div id="navbar-placeholder"></div>

  <main class="container my-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <h1 class="h3 mb-0">Post Flight Log</h1>
        <div class="text-muted small">Complete your flight and file the log.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="my-bookings.html">Back</a>
        <button id="submitBtnTop" class="btn btn-primary" type="submit" form="flightLogForm">Submit Log</button>
      </div>
    </div>

    <!-- Skeleton while booking prefill loads -->
    <div id="prefillSkeleton" class="card section-card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
        </div>
      </div>
    </div>

    <form id="flightLogForm" class="fade-in" novalidate>


    



      <!-- Basic details -->
      
      <div class="card section-card alt mb-3">
        <div class="card-header"><strong>Flight details</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="picName">PIC Name</label>
              <input class="form-control" id="picName" name="picName" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="flightDate">Date</label>
              <input class="form-control" id="flightDate" name="flightDate" type="date" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="aircraft">Aircraft</label>
              <input class="form-control" id="aircraft" name="aircraft" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="from">From</label>
              <input class="form-control" id="from" name="from" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="to">To</label>
              <input class="form-control" id="to" name="to" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="authorised">Authorised</label>
              <input class="form-control" id="authorised" name="authorised" type="text">
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" for="p2">P2</label>
              <input class="form-control" id="p2" name="p2" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p3">P3</label>
              <input class="form-control" id="p3" name="p3" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p4">P4</label>
              <input class="form-control" id="p4" name="p4" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="instructional">Instructional flight?</label>
              <select class="form-select" id="instructional" name="instructional">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
        </div>
      </div>



      <div class="card section-card alt mb-3">
        <div class="card-header"><strong>Times</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="offChocks">Off chocks</label>
              <input class="form-control" id="offChocks" name="offChocks" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="takeoff">Takeoff</label>
              <input class="form-control" id="takeoff" name="takeoff" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="land">Land</label>
              <input class="form-control" id="land" name="land" type="time" step="300">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="onChocks">On chocks</label>
              <input class="form-control" id="onChocks" name="onChocks" type="time" step="300">
            </div>


          <div class="row g-3 mt-1">
            <div class="col-12 col-md-6">
              <label class="form-label" for="blockTime">Block time (auto)</label>
              <input class="form-control" id="blockTime" type="text" readonly placeholder="--:--">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="airTime">Air time (auto)</label>
              <input class="form-control" id="airTime" type="text" readonly placeholder="--:--">
            </div>
          </div>

<div class="form-text mt-2" id="timeHelp">
  Times auto-calculate once all four fields are complete.
</div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-md-6">
      <label class="form-label">Start tacho</label>
  
      <div class="tacho" data-tacho="start">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 1">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 2">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 3">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho digit 4">
        <span class="tacho-dot" aria-hidden="true">.</span>
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="Start tacho decimal digit">
      </div>
  
      <!-- hidden actual value -->
      <input type="hidden" id="startTacho" name="startTacho" value="">
    </div>
  
    <div class="col-12 col-md-6">
      <label class="form-label">End tacho</label>
  
      <div class="tacho" data-tacho="end">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 1">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 2">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 3">
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho digit 4">
        <span class="tacho-dot" aria-hidden="true">.</span>
        <input class="tacho-digit" inputmode="numeric" maxlength="1" aria-label="End tacho decimal digit">
      </div>
  
      <!-- hidden actual value -->
      <input type="hidden" id="endTacho" name="endTacho" value="">
    </div>
  
    <div class="col-12 col-md-6">
      <label class="form-label" for="tachoDiff">Tacho difference (auto)</label>
      <input class="form-control" id="tachoDiff" type="text" readonly placeholder="--.-">
      <div class="form-text">Calculated once both tachos are entered.</div>
    </div>
  </div>


      

      <!-- Fuel & oil -->
      <div class="card section-card alt mb-3">
        <div class="card-header"><strong>Fuel & oil</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedLfc">Fuel uplifted at LFC (litres)</label>
              <input class="form-control" id="fuelUpliftedLfc" name="fuelUpliftedLfc" type="number" step="0.1" min="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelRemaining">Remaining fuel</label>
              <input class="form-control" id="fuelRemaining" name="fuelRemaining" type="text" placeholder="e.g. Tabs / litres">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedElsewhere">Fuel uplifted elsewhere (litres)</label>
              <input class="form-control" id="fuelUpliftedElsewhere" name="fuelUpliftedElsewhere" type="number" step="0.1" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelCost">Cost of fuel (£)</label>
              <input class="form-control" id="fuelCost" name="fuelCost" type="number" step="0.01" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="oilUploaded">Oil uploaded</label>
              <input class="form-control" id="oilUploaded" name="oilUploaded" type="text" placeholder="e.g. 1 litre">
            </div>
          </div>
        </div>
      </div>

      <!-- Landings & payment -->
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card section-card alt h-100">
            <div class="card-header"><strong>Landings</strong></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="landingsKemble">Kemble total landings (inc T&G / overshoots)</label>
                  <input class="form-control" id="landingsKemble" name="landingsKemble" type="number" step="1" min="0" value="0">
                </div>
                <div class="col-12">
                  <label class="form-label" for="landingsOther">T&Gs and landings at other airfields</label>
                  <input class="form-control" id="landingsOther" name="landingsOther" type="number" step="1" min="0" value="0">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card section-card alt h-100">
            <div class="card-header"><strong>Payment</strong></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="payer">Who is paying for hire?</label>
                  <input class="form-control" id="payer" name="payer" type="text" placeholder="Name / member" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="paymentMethod">Payment method</label>
                  <select class="form-select" id="paymentMethod" name="paymentMethod">
                    <option value="" selected>Choose…</option>
                    <option>Card</option>
                    <option>Cash</option>
                    <option>Account</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="tempMember">Temp member?</label>
                  <select class="form-select" id="tempMember" name="tempMember">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="maintenanceTrip">Maintenance trip?</label>
                  <select class="form-select" id="maintenanceTrip" name="maintenanceTrip">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="rescueFlight">Rescue flight?</label>
                  <select class="form-select" id="rescueFlight" name="rescueFlight">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Confirmation + submit -->
      <div class="card section-card alt mt-3">
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="confirm" required>
            <label class="form-check-label" for="confirm">
              I confirm as pilot in command the information in this form is correct.
            </label>
          </div>
          <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
            <a class="btn btn-outline-secondary" href="my-bookings.html">Cancel</a>
            <button id="submitBtn" class="btn btn-primary" type="submit">Submit Log</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="bookingId" name="bookingId" />
    </form>
  </main>


<script>
  const TIME_IDS = ["offChocks", "takeoff", "land", "onChocks"];

  function parseHHMM(v) {
    if (!v || !/^\d{2}:\d{2}$/.test(v)) return null;
    const [hh, mm] = v.split(":").map(Number);
    if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
    return hh * 60 + mm;
  }

  function minutesToHHMM(mins) {
    const hh = Math.floor(mins / 60);
    const mm = mins % 60;
    return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
  }

  function snapMinutesTo5(mins) {
    return Math.round(mins / 5) * 5;
  }

  function duration(start, end) {
    let d = end - start;
    if (d < 0) d += 24 * 60; // overnight
    return d;
  }

  function allTimesPresent() {
    return TIME_IDS.every(id => {
      const v = document.getElementById(id)?.value;
      return v && /^\d{2}:\d{2}$/.test(v);
    });
  }

  function clearInvalid() {
    TIME_IDS.forEach(id => {
      const el = document.getElementById(id);
      el?.classList.remove("is-invalid");
    });
  }

  function setInvalid(flag) {
    TIME_IDS.forEach(id => {
      const el = document.getElementById(id);
      el?.classList.toggle("is-invalid", flag);
    });
  }

  function validateAndCalcTimes() {
    // Do nothing until all four are filled
    if (!allTimesPresent()) {
      clearInvalid();
      return;
    }

    const off = parseHHMM(offChocks.value);
    const to  = parseHHMM(takeoff.value);
    const land= parseHHMM(land.value);
    const on  = parseHHMM(onChocks.value);

    // Snap all to nearest 5 minutes
    const snapped = {
      off: snapMinutesTo5(off),
      to: snapMinutesTo5(to),
      land: snapMinutesTo5(land),
      on: snapMinutesTo5(on)
    };

    offChocks.value = minutesToHHMM(snapped.off);
    takeoff.value   = minutesToHHMM(snapped.to);
    land.value      = minutesToHHMM(snapped.land);
    onChocks.value  = minutesToHHMM(snapped.on);

    const block = duration(snapped.off, snapped.on);
    const air   = duration(snapped.to, snapped.land);

    let invalid = false;

    if (air > block) invalid = true;
    if (block <= 0) invalid = true;
    if (block > 16 * 60) invalid = true;

    // taxi sanity (optional but sensible)
    const taxiOut = duration(snapped.off, snapped.to);
    const taxiIn  = duration(snapped.land, snapped.on);
    if (taxiOut > 6 * 60 || taxiIn > 6 * 60) invalid = true;

    setInvalid(invalid);

    if (invalid) {
      if (typeof showToast === "function") {
        showToast(
          "Check time order: Off chocks → Takeoff → Land → On chocks",
          { variant: "danger" }
        );
      }
      return;
    }

    // Optional outputs if you added them earlier
    const blockOut = document.getElementById("blockTime");
    const airOut = document.getElementById("airTime");
    if (blockOut) blockOut.value = minutesToHHMM(block);
    if (airOut) airOut.value = minutesToHHMM(air);
  }

  TIME_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", validateAndCalcTimes);
    el.addEventListener("blur", validateAndCalcTimes);
  });
</script>


<script>
  function timeToMinutes(hhmm) {
    if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
    const [hh, mm] = hhmm.split(":").map(n => parseInt(n, 10));
    if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
    return hh * 60 + mm;
  }

  function minutesToHHMM(mins) {
    const hh = Math.floor(mins / 60);
    const mm = mins % 60;
    return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
  }

  // Computes duration allowing overnight crossing (adds 24h if end < start)
  function durationMinutes(startMins, endMins) {
    if (startMins == null || endMins == null) return null;
    let d = endMins - startMins;
    if (d < 0) d += 24 * 60; // cross midnight
    return d;
  }

  function setInvalid(el, isInvalid) {
    if (!el) return;
    el.classList.toggle("is-invalid", isInvalid);
  }

  function clearOutputs() {
    const block = document.getElementById("blockTime");
    const air = document.getElementById("airTime");
    if (block) block.value = "";
    if (air) air.value = "";
  }

  function autoCalcTimes() {
    const offEl = document.getElementById("offChocks");
    const toEl  = document.getElementById("takeoff");
    const landEl= document.getElementById("land");
    const onEl  = document.getElementById("onChocks");

    const blockOut = document.getElementById("blockTime");
    const airOut = document.getElementById("airTime");

    const off = timeToMinutes(offEl?.value);
    const to  = timeToMinutes(toEl?.value);
    const land= timeToMinutes(landEl?.value);
    const on  = timeToMinutes(onEl?.value);

    // Only compute once all four are present
    if ([off, to, land, on].some(v => v == null)) {
      [offEl, toEl, landEl, onEl].forEach(el => setInvalid(el, false));
      clearOutputs();
      return;
    }

    const blockMins = durationMinutes(off, on);
    const airMins = durationMinutes(to, land);

    // Basic sanity checks:
    // - zero durations are allowed (if you want to disallow, change <= 0)
    // - cap at 16 hours to catch accidental wrong entries
    let invalid = false;

    if (blockMins == null || airMins == null) invalid = true;
    if (blockMins < 0 || airMins < 0) invalid = true; // should never happen now
    if (airMins > blockMins) invalid = true; // can't fly longer than block time
    if (blockMins > 16 * 60) invalid = true;

    // Also enforce sequence (as best we can with potential overnight):
    // If someone enters takeoff before offchocks in same-day sense, that's usually wrong.
    // We'll enforce using durations too: off->to and land->on should be >= 0 and reasonable.
    const taxiOut = durationMinutes(off, to);
    const taxiIn  = durationMinutes(land, on);
    if (taxiOut == null || taxiIn == null) invalid = true;
    if (taxiOut > 6 * 60 || taxiIn > 6 * 60) invalid = true; // absurd taxi times

    [offEl, toEl, landEl, onEl].forEach(el => setInvalid(el, invalid));

    if (invalid) {
      clearOutputs();
      if (typeof showToast === "function") {
        showToast("Check time order: Off chocks → Takeoff → Land → On chocks. Durations can't be negative.", { variant: "danger" });
      }
      return;
    }

    if (blockOut) blockOut.value = minutesToHHMM(blockMins);
    if (airOut) airOut.value = minutesToHHMM(airMins);
  }

  // Hook up listeners
  ["offChocks", "takeoff", "land", "onChocks"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", autoCalcTimes);
    if (el) el.addEventListener("change", autoCalcTimes);
  });
</script>

<script>
  function clampDigitChar(ch) {
    return /[0-9]/.test(ch) ? ch : "";
  }

  function getDigits(container) {
    return Array.from(container.querySelectorAll(".tacho-digit"));
  }

  function buildTachoString(container) {
    const digits = getDigits(container).map(i => (i.value || "0"));
    // first 4 digits are whole hours, last digit is tenths
    return `${digits[0]}${digits[1]}${digits[2]}${digits[3]}.${digits[4]}`;
  }

  function isComplete(container) {
    // consider complete when ALL 5 boxes have a digit
    return getDigits(container).every(i => /^[0-9]$/.test(i.value));
  }

  function tachoToTenths(tachoStr) {
    // "0123.4" -> 1234 tenths
    if (!/^\d{4}\.\d$/.test(tachoStr)) return null;
    const whole = parseInt(tachoStr.slice(0, 4), 10);
    const tenth = parseInt(tachoStr.slice(5, 6), 10);
    if (Number.isNaN(whole) || Number.isNaN(tenth)) return null;
    return whole * 10 + tenth;
  }

  function tenthsToTacho(tenths) {
    const whole = Math.floor(tenths / 10);
    const tenth = tenths % 10;
    return String(whole).padStart(4, "0") + "." + String(tenth);
  }

  function syncHidden(container) {
    const kind = container.getAttribute("data-tacho"); // "start" or "end"
    const hidden = document.getElementById(kind === "start" ? "startTacho" : "endTacho");
    if (!hidden) return;

    if (!isComplete(container)) {
      hidden.value = "";
      return;
    }

    hidden.value = buildTachoString(container);
  }

  function validateAndCalcTacho() {
    const startBox = document.querySelector('.tacho[data-tacho="start"]');
    const endBox = document.querySelector('.tacho[data-tacho="end"]');
    const diffOut = document.getElementById("tachoDiff");

    if (!startBox || !endBox) return;

    // only validate once BOTH are complete
    if (!isComplete(startBox) || !isComplete(endBox)) {
      startBox.classList.remove("invalid");
      endBox.classList.remove("invalid");
      if (diffOut) diffOut.value = "";
      return;
    }

    const startStr = buildTachoString(startBox);
    const endStr = buildTachoString(endBox);

    const startT = tachoToTenths(startStr);
    const endT = tachoToTenths(endStr);

    const invalid = (startT == null || endT == null || endT < startT);

    startBox.classList.toggle("invalid", invalid);
    endBox.classList.toggle("invalid", invalid);

    if (invalid) {
      if (diffOut) diffOut.value = "";
      if (typeof showToast === "function") {
        showToast("End tacho must be greater than or equal to start tacho.", { variant: "danger" });
      }
      return;
    }

    const diffTenths = endT - startT;
    if (diffOut) diffOut.value = tenthsToTacho(diffTenths); // e.g. 0001.7
  }

  function wireTacho(container) {
    const inputs = getDigits(container);

    inputs.forEach((input, idx) => {
      input.setAttribute("autocomplete", "off");
      input.setAttribute("pattern", "[0-9]*");

      input.addEventListener("input", (e) => {
        const v = clampDigitChar(input.value);
        input.value = v;

        if (v && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
          inputs[idx + 1].select?.();
        }

        syncHidden(container);
        validateAndCalcTacho();
      });

      input.addEventListener("keydown", (e) => {
        const key = e.key;

        // Backspace: move left if empty, otherwise clear
        if (key === "Backspace") {
          if (input.value) {
            input.value = "";
            e.preventDefault();
          } else if (idx > 0) {
            inputs[idx - 1].focus();
            inputs[idx - 1].value = "";
            e.preventDefault();
          }
          syncHidden(container);
          validateAndCalcTacho();
          return;
        }

        // Arrow navigation
        if (key === "ArrowLeft" && idx > 0) {
          inputs[idx - 1].focus();
          e.preventDefault();
          return;
        }
        if (key === "ArrowRight" && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
          e.preventDefault();
          return;
        }

        // Only allow digits, tab, etc.
        if (
          key.length === 1 &&
          !/[0-9]/.test(key)
        ) {
          e.preventDefault();
        }
      });

      input.addEventListener("focus", () => {
        // select content for quick overwrite
        input.select?.();
      });

      input.addEventListener("blur", () => {
        syncHidden(container);
        validateAndCalcTacho();
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".tacho").forEach(wireTacho);
  });
</script>

<script>
  function isFiveMinuteIncrement(hhmm) {
    if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return false;
    const minutes = parseInt(hhmm.split(":")[1], 10);
    return minutes % 5 === 0;
  }

  function enforceFiveMinuteStep(e) {
    const el = e.target;
    if (!el || !el.value) return;

    if (!isFiveMinuteIncrement(el.value)) {
      el.classList.add("is-invalid");
      if (typeof showToast === "function") {
        showToast("Times must be entered in 5-minute increments.", { variant: "warning" });
      }
      return;
    }

    el.classList.remove("is-invalid");
  }

  ["offChocks", "takeoff", "land", "onChocks"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", enforceFiveMinuteStep);
    el.addEventListener("blur", enforceFiveMinuteStep);
  });
</script>

  <!-- Auth + shared UI helpers -->
  <script src="js/auth.js"></script>
  <script src="js/logout.js"></script>
  <script src="js/ui.js"></script>

  <script>
    // NOTE: Keep this consistent with your other pages
    // FlightBookings API base
    const API_BASE = "https://rj7w2wkpgj.execute-api.eu-west-2.amazonaws.com";

    const params = new URLSearchParams(window.location.search);
    const bookingId = params.get("id");
    const prefillSkeleton = document.getElementById("prefillSkeleton");
    const form = document.getElementById("flightLogForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitBtnTop = document.getElementById("submitBtnTop");

    function setPrefillVisible(isReady) {
      if (!prefillSkeleton || !form) return;
      prefillSkeleton.classList.toggle("d-none", isReady);
      form.classList.toggle("ready", isReady);
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function prefillFromBooking() {
      if (!bookingId) {
        showToast("Missing booking id", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      document.getElementById("bookingId").value = bookingId;
      document.getElementById("flightDate").value = todayISO();

      // The booking API should already exist (used by edit-booking.html)
      const res = await authFetch(`${API_BASE}/get_booking/${bookingId}`);
      if (!res || !res.ok) {
        showToast("Failed to load booking for prefill", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      const b = await res.json();

      // Prefill fields you mentioned
      document.getElementById("picName").value = b.pic || b.PIC || b.picName || localStorage.getItem("username") || "";
      document.getElementById("from").value = b.from ?? "";
      document.getElementById("to").value = b.to ?? "";
      document.getElementById("authorised").value = b.authorised ?? b.authorized ?? "";
      document.getElementById("aircraft").value = b.aircraft ?? "";

      // P2–P4: depending on how you store it today
      document.getElementById("p2").value = b.p2 ?? b.passenger2 ?? b.pax2 ?? "";
      document.getElementById("p3").value = b.p3 ?? b.passenger3 ?? b.pax3 ?? "";
      document.getElementById("p4").value = b.p4 ?? b.passenger4 ?? b.pax4 ?? "";

      setPrefillVisible(true);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Basic bootstrap validation feel
      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        showToast("Please complete the required fields", { variant: "warning" });
        return;
      }

      const payload = Object.fromEntries(new FormData(form).entries());

      setButtonLoading(submitBtn, true, { loadingText: "Submitting…" });
      setButtonLoading(submitBtnTop, true, { loadingText: "Submitting…" });

      try {
        // MVP endpoint you will add: writes the log AND removes booking from active flights.
        const res = await authFetch(`${API_BASE}/complete_booking/${bookingId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res || !res.ok) throw new Error(`Submit failed (${res?.status || "no response"})`);

        showToast("Flight log submitted", { variant: "success" });
        setTimeout(() => { window.location.href = "my-bookings.html"; }, 600);
      } catch (err) {
        console.error(err);
        showToast("There was a problem submitting the flight log.", { variant: "danger" });
      } finally {
        setButtonLoading(submitBtn, false);
        setButtonLoading(submitBtnTop, false);
      }
    });

    // Navbar
    fetch("/partials/navbar.html")
      .then(res => res.text())
      .then(html => {
        const mount = document.getElementById("navbar-placeholder");
        if (mount) mount.innerHTML = html;
        // Ensure logout + username in navbar works after injecting
        const s = document.createElement("script");
        s.src = "logout.js";
        document.body.appendChild(s);
      })
      .catch(err => console.error("Navbar load failed", err));

    // Prefill
    withLoading(async () => {
      setPrefillVisible(false);
      await prefillFromBooking();
    });
  </script>
</body>
</html>
