<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Post Flight Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <style>
    body.loading { cursor: wait; }

    .fade-in { opacity: 0; transform: translateY(4px); transition: opacity .25s ease, transform .25s ease; }
    .fade-in.ready { opacity: 1; transform: translateY(0); }

    .skeleton {
      height: 38px;
      border-radius: 0.375rem;
      background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 37%, #e9ecef 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Keep the layout tidy on phones */
    .section-card { border: 0; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
    .section-card .card-header { background: #f8f9fa; }
    .form-label { font-weight: 600; }
  </style>
</head>

<body>
  <div id="navbar-placeholder"></div>

  <main class="container my-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <h1 class="h3 mb-0">Post Flight Log</h1>
        <div class="text-muted small">Complete your flight and file the log.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="my-bookings.html">Back</a>
        <button id="submitBtnTop" class="btn btn-primary" type="submit" form="flightLogForm">Submit Log</button>
      </div>
    </div>

    <!-- Skeleton while booking prefill loads -->
    <div id="prefillSkeleton" class="card section-card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-4"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
          <div class="col-12 col-lg-6"><div class="skeleton"></div></div>
        </div>
      </div>
    </div>

    <form id="flightLogForm" class="fade-in" novalidate>

      <!-- Basic details -->
      <div class="card section-card mb-3">
        <div class="card-header"><strong>Flight details</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="picName">PIC Name</label>
              <input class="form-control" id="picName" name="picName" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="flightDate">Date</label>
              <input class="form-control" id="flightDate" name="flightDate" type="date" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="aircraft">Aircraft</label>
              <input class="form-control" id="aircraft" name="aircraft" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="from">From</label>
              <input class="form-control" id="from" name="from" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="to">To</label>
              <input class="form-control" id="to" name="to" type="text" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label" for="authorised">Authorised</label>
              <input class="form-control" id="authorised" name="authorised" type="text">
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" for="p2">P2</label>
              <input class="form-control" id="p2" name="p2" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p3">P3</label>
              <input class="form-control" id="p3" name="p3" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="p4">P4</label>
              <input class="form-control" id="p4" name="p4" type="text">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="instructional">Instructional flight?</label>
              <select class="form-select" id="instructional" name="instructional">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Times & tacho -->
      <div class="card section-card mb-3">
        <div class="card-header"><strong>Times</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="offChocks">Off chocks</label>
              <input class="form-control" id="offChocks" name="offChocks" type="time">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="takeoff">Takeoff</label>
              <input class="form-control" id="takeoff" name="takeoff" type="time">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="land">Land</label>
              <input class="form-control" id="land" name="land" type="time">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label" for="onChocks">On chocks</label>
              <input class="form-control" id="onChocks" name="onChocks" type="time">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="startTacho">Start tacho</label>
              <input class="form-control" id="startTacho" name="startTacho" type="number" step="0.1" min="0">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="endTacho">End tacho</label>
              <input class="form-control" id="endTacho" name="endTacho" type="number" step="0.1" min="0">
            </div>
          </div>
        </div>
      </div>

      <!-- Fuel & oil -->
      <div class="card section-card mb-3">
        <div class="card-header"><strong>Fuel & oil</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedLfc">Fuel uplifted at LFC (litres)</label>
              <input class="form-control" id="fuelUpliftedLfc" name="fuelUpliftedLfc" type="number" step="0.1" min="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelRemaining">Remaining fuel</label>
              <input class="form-control" id="fuelRemaining" name="fuelRemaining" type="text" placeholder="e.g. Tabs / litres">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelUpliftedElsewhere">Fuel uplifted elsewhere (litres)</label>
              <input class="form-control" id="fuelUpliftedElsewhere" name="fuelUpliftedElsewhere" type="number" step="0.1" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="fuelCost">Cost of fuel (£)</label>
              <input class="form-control" id="fuelCost" name="fuelCost" type="number" step="0.01" min="0" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="oilUploaded">Oil uploaded</label>
              <input class="form-control" id="oilUploaded" name="oilUploaded" type="text" placeholder="e.g. 1 litre">
            </div>
          </div>
        </div>
      </div>

      <!-- Landings & payment -->
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card section-card h-100">
            <div class="card-header"><strong>Landings</strong></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="landingsKemble">Kemble total landings (inc T&G / overshoots)</label>
                  <input class="form-control" id="landingsKemble" name="landingsKemble" type="number" step="1" min="0" value="0">
                </div>
                <div class="col-12">
                  <label class="form-label" for="landingsOther">T&Gs and landings at other airfields</label>
                  <input class="form-control" id="landingsOther" name="landingsOther" type="number" step="1" min="0" value="0">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card section-card h-100">
            <div class="card-header"><strong>Payment</strong></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="payer">Who is paying for hire?</label>
                  <input class="form-control" id="payer" name="payer" type="text" placeholder="Name / member" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="paymentMethod">Payment method</label>
                  <select class="form-select" id="paymentMethod" name="paymentMethod">
                    <option value="" selected>Choose…</option>
                    <option>Card</option>
                    <option>Cash</option>
                    <option>Account</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="tempMember">Temp member?</label>
                  <select class="form-select" id="tempMember" name="tempMember">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="maintenanceTrip">Maintenance trip?</label>
                  <select class="form-select" id="maintenanceTrip" name="maintenanceTrip">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="rescueFlight">Rescue flight?</label>
                  <select class="form-select" id="rescueFlight" name="rescueFlight">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmation + submit -->
      <div class="card section-card mt-3">
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="confirm" required>
            <label class="form-check-label" for="confirm">
              I confirm as pilot in command the information in this form is correct.
            </label>
          </div>
          <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
            <a class="btn btn-outline-secondary" href="my-bookings.html">Cancel</a>
            <button id="submitBtn" class="btn btn-primary" type="submit">Submit Log</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="bookingId" name="bookingId" />
    </form>
  </main>

  <!-- Auth + shared UI helpers -->
  <script src="js/auth.js"></script>
  <script src="js/ui.js"></script>

  <script>
    // NOTE: Keep this consistent with your other pages
    // FlightBookings API base
    const API_BASE = "https://rj7w2wkpgj.execute-api.eu-west-2.amazonaws.com";

    const params = new URLSearchParams(window.location.search);
    const bookingId = params.get("id");
    const prefillSkeleton = document.getElementById("prefillSkeleton");
    const form = document.getElementById("flightLogForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitBtnTop = document.getElementById("submitBtnTop");

    function setPrefillVisible(isReady) {
      if (!prefillSkeleton || !form) return;
      prefillSkeleton.classList.toggle("d-none", isReady);
      form.classList.toggle("ready", isReady);
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function prefillFromBooking() {
      if (!bookingId) {
        showToast("Missing booking id", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      document.getElementById("bookingId").value = bookingId;
      document.getElementById("flightDate").value = todayISO();

      // The booking API should already exist (used by edit-booking.html)
      const res = await authFetch(`${API_BASE}/get_booking/${bookingId}`);
      if (!res || !res.ok) {
        showToast("Failed to load booking for prefill", { variant: "danger" });
        setPrefillVisible(true);
        return;
      }

      const b = await res.json();

      // Prefill fields you mentioned
      document.getElementById("picName").value = b.pic || b.PIC || b.picName || localStorage.getItem("username") || "";
      document.getElementById("from").value = b.from ?? "";
      document.getElementById("to").value = b.to ?? "";
      document.getElementById("authorised").value = b.authorised ?? b.authorized ?? "";
      document.getElementById("aircraft").value = b.aircraft ?? "";

      // P2–P4: depending on how you store it today
      document.getElementById("p2").value = b.p2 ?? b.passenger2 ?? b.pax2 ?? "";
      document.getElementById("p3").value = b.p3 ?? b.passenger3 ?? b.pax3 ?? "";
      document.getElementById("p4").value = b.p4 ?? b.passenger4 ?? b.pax4 ?? "";

      setPrefillVisible(true);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Basic bootstrap validation feel
      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        showToast("Please complete the required fields", { variant: "warning" });
        return;
      }

      const payload = Object.fromEntries(new FormData(form).entries());

      setButtonLoading(submitBtn, true, { loadingText: "Submitting…" });
      setButtonLoading(submitBtnTop, true, { loadingText: "Submitting…" });

      try {
        // MVP endpoint you will add: writes the log AND removes booking from active flights.
        const res = await authFetch(`${API_BASE}/complete_booking/${bookingId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res || !res.ok) throw new Error(`Submit failed (${res?.status || "no response"})`);

        showToast("Flight log submitted", { variant: "success" });
        setTimeout(() => { window.location.href = "my-bookings.html"; }, 600);
      } catch (err) {
        console.error(err);
        showToast("There was a problem submitting the flight log.", { variant: "danger" });
      } finally {
        setButtonLoading(submitBtn, false);
        setButtonLoading(submitBtnTop, false);
      }
    });

    // Navbar
    fetch("/partials/navbar.html")
      .then(res => res.text())
      .then(html => {
        const mount = document.getElementById("navbar-placeholder");
        if (mount) mount.innerHTML = html;
        // Ensure logout + username in navbar works after injecting
        const s = document.createElement("script");
        s.src = "logout.js";
        document.body.appendChild(s);
      })
      .catch(err => console.error("Navbar load failed", err));

    // Prefill
    withLoading(async () => {
      setPrefillVisible(false);
      await prefillFromBooking();
    });
  </script>
</body>
</html>
