<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <script src="js/auth.js"></script>
  <script src="js/logout.js"></script>

  <style>
    body.loading { cursor: wait; }

    /* Skeleton shimmer */
    .skeleton {
      background: linear-gradient(
        90deg,
        #e9ecef 25%,
        #f8f9fa 37%,
        #e9ecef 63%
      );
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 0.5rem;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    .skeleton-line {
      height: 14px;
      margin: 8px 0;
    }

    .skeleton-btn {
      height: 32px;
      border-radius: 0.375rem;
    }

    .fade-in {
      animation: fadeIn 0.25s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>


</head>

<body>

<div class="container-fluid p-2 bg-primary text-white text-center">
  <h2>BOOKINGS</h2>
</div>

<div id="navbar-placeholder"></div>

<div class="container mt-4">
  <h3 class="mb-3">My Bookings</h3>

  <div id="bookings"></div>
</div>

<script>
const API_BASE = "https://rj7w2wkpgj.execute-api.eu-west-2.amazonaws.com";

async function loadBookings() {
  showBookingsSkeleton();

  try {
    // Use authFetch so token refresh works reliably.
    const res = await authFetch(`${API_BASE}/get_bookings_all`);
    if (!res || !res.ok) {
      throw new Error(`Failed to load bookings (${res?.status || "no response"})`);
    }

    const data = await res.json();
    renderBookings(Array.isArray(data) ? data : []);
  } catch (err) {
    console.error(err);
    document.getElementById("bookings").innerHTML =
      "<div class=\"alert alert-danger\">Unable to load bookings. Please try again.</div>";
  } finally {
    document.body.classList.remove("loading");
  }
}

function showBookingsSkeleton() {
  document.body.classList.add("loading");
  const container = document.getElementById("bookings");

  // Desktop table skeleton
  let html = `
    <div class="table-responsive d-none d-md-block">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Aircraft</th>
            <th>ETA</th>
            <th>Route</th>
            <th>Reason</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
  `;

  for (let i = 0; i < 6; i++) {
    html += `
      <tr>
        <td><div class="skeleton" style="height:14px; width:120px"></div></td>
        <td><div class="skeleton" style="height:14px; width:140px"></div></td>
        <td><div class="skeleton" style="height:14px; width:180px"></div></td>
        <td><div class="skeleton" style="height:14px; width:160px"></div></td>
        <td>
          <div class="d-flex gap-2">
            <div class="skeleton skeleton-btn" style="width:110px"></div>
            <div class="skeleton skeleton-btn" style="width:70px"></div>
            <div class="skeleton skeleton-btn" style="width:70px"></div>
          </div>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table></div>`;

  // Mobile cards skeleton
  html += `<div class="d-md-none">`;
  for (let i = 0; i < 4; i++) {
    html += `
      <div class="card mb-3">
        <div class="card-body">
          <div class="skeleton" style="height:18px; width:45%; margin-bottom:12px"></div>
          <div class="skeleton skeleton-line" style="width:70%"></div>
          <div class="skeleton skeleton-line" style="width:55%"></div>
          <div class="skeleton skeleton-line" style="width:85%"></div>
          <div class="skeleton skeleton-btn mt-3" style="width:100%"></div>
          <div class="skeleton skeleton-btn mt-2" style="width:100%"></div>
          <div class="skeleton skeleton-btn mt-2" style="width:100%"></div>
        </div>
      </div>
    `;
  }
  html += `</div>`;

  container.innerHTML = html;
}

function renderBookings(bookings) {
  const container = document.getElementById("bookings");

  if (!bookings.length) {
    container.innerHTML = "<p>No bookings found.</p>";
    return;
  }

  let html = `
  <div class="table-responsive d-none d-md-block">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Aircraft</th>
          <th>ETA</th>
          <th>Route</th>
          <th>Reason</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
  `;

  bookings.forEach(b => {
    html += `
      <tr>
        <td>${b.aircraft}</td>
        <td>${b.eta}</td>
        <td>${b.from} → ${b.to}</td>
        <td>${b.reason}</td>

        <td class="d-flex gap-2">

        <button class="btn btn-sm btn-success"
          onclick="deleteBooking('${b.bookingId}')">
          Complete Flight
        </button>
         
        <a class="btn btn-sm btn-primary"
          href="edit-booking.html?id=${b.bookingId}">
          Edit
        </a>

        <button class="btn btn-sm btn-danger"
          onclick="deleteBooking('${b.bookingId}')">
          Delete
        </button>
      
        </td>
     

        </tr>
    `;
  });

  html += `</tbody></table></div>`;

  // Mobile cards
  html += `<div class="d-md-none">`;
  bookings.forEach(b => {
    html += `
      <div class="card mb-3">
        <div class="card-body">
          <h5>${b.aircraft}</h5>
          <p><strong>ETA:</strong> ${b.eta}</p>
          <p>${b.from} → ${b.to}</p>
          <p>${b.reason}</p>

          <button type="button" class="btn btn-success w-100 mt-2"
            onclick="deleteBooking('${b.bookingId}')">
            Complete Flight
          </button>

          
          <a class="btn btn-primary w-100 mt-2" href="edit-booking.html?id=${b.bookingId}">
            Edit Booking
          </a>

          <button type="button" class="btn btn-danger w-100 mt-2"
            onclick="deleteBooking('${b.bookingId}')">
            Delete Booking
          </button>
      
        </div>
        </div>
    `;
  });
  html += `</div>`;

  container.innerHTML = html;
  container.classList.add("fade-in");
}

loadBookings();
</script>


<script>
async function deleteBooking(bookingId) {
  if (!confirm("Are you sure you want to delete this booking?")) {
    return;
  }

  try {
    document.body.classList.add("loading");
    const res = await authFetch(`${API_BASE}/delete_booking/${bookingId}`, {
      method: "DELETE"
    });

    if (!res.ok) {
      throw new Error("Failed to delete booking");
    }

    // Reload bookings after successful delete
    loadBookings();

  } catch (err) {
    console.error(err);
    alert("There was a problem deleting the booking.");
  } finally {
    document.body.classList.remove("loading");
  }
}
</script>


<script>
fetch("/partials/navbar.html")
  .then(res => {
    if (!res.ok) throw new Error("Failed to load navbar.html");
    return res.text();
  })
  .then(html => {
    const mount = document.getElementById("navbar-placeholder");
    if (!mount) return;

    mount.innerHTML = html;

    // Active link logic (robust)
    const currentPath = window.location.pathname.replace(/\/$/, "");
    document.querySelectorAll(".nav-link").forEach(link => {
      const linkPath = new URL(link.href).pathname.replace(/\/$/, "");
      if (linkPath === currentPath) {
        link.classList.add("active");
        link.setAttribute("aria-current", "page");
      }
    });

    // ✅ Navbar is now in DOM
    window.dispatchEvent(new Event("navbar:loaded"));
  })
  .catch(err => console.error(err));
</script>



</body>
</html>
