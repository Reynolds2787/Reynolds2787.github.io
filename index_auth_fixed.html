<!DOCTYPE html>
<html lang="en">
<head>
  <title>EFM Web App</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- üîê Unified Cognito Auth (Authorization Code Flow) -->
  <script>
  (async function () {
    const COGNITO_DOMAIN = "https://eu-west-2gytf1n6yk.auth.eu-west-2.amazoncognito.com";
    const CLIENT_ID = "r3kibut2khk4blk1mj7ti9c6p";
    const REDIRECT_URI = "https://efmapp.co.uk/";

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    // 1Ô∏è‚É£ Exchange authorization code for tokens
    if (code) {
      try {
        const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            grant_type: "authorization_code",
            client_id: CLIENT_ID,
            redirect_uri: REDIRECT_URI,
            code
          })
        });

        const tokens = await res.json();

        localStorage.setItem("access_token", tokens.access_token);
        localStorage.setItem("id_token", tokens.id_token);
        localStorage.setItem("refresh_token", tokens.refresh_token);

        const payload = JSON.parse(atob(tokens.id_token.split('.')[1]));
        localStorage.setItem(
          "username",
          payload.name || payload.email || "User"
        );

        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (e) {
        console.error("Token exchange failed", e);
      }
    }

    // 2Ô∏è‚É£ Enforce login only AFTER exchange attempt
    const accessToken = localStorage.getItem("access_token");
    if (!accessToken) {
      window.location.href =
        `${COGNITO_DOMAIN}/login` +
        `?client_id=${CLIENT_ID}` +
        `&response_type=code` +
        `&scope=openid+email+profile` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }
  })();
  </script>
</head>

<body>

<div class="container-fluid p-2 bg-primary text-white text-center">
  <h1>EFM WEB APP</h1>
</div>

<div class="alert alert-warning">
  <strong>Warning</strong> Website is under maintenance
</div>

<nav class="navbar navbar-expand-sm navbar-dark bg-dark sticky-top shadow-sm py-1">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="index.html">WELCOME TO LFC!</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#efmNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="efmNavbar">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="stats.html">Stats</a></li>
        <li class="nav-item"><a class="nav-link" href="booking_out_form.html">Book Out</a></li>
      </ul>

      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center gap-1" href="#" role="button" data-bs-toggle="dropdown">
            üë§ <span id="loggedInUser">User</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="profile.html">Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" id="logoutBtn">Logout</button></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const userEl = document.getElementById("loggedInUser");
  const logoutEl = document.getElementById("logoutBtn");

  if (userEl) {
    userEl.textContent = localStorage.getItem("username") || "User";
  }

  if (logoutEl) {
    logoutEl.onclick = function () {
      localStorage.clear();
      window.location.href =
        "https://eu-west-2gytf1n6yk.auth.eu-west-2.amazoncognito.com/logout" +
        "?client_id=r3kibut2khk4blk1mj7ti9c6p" +
        "&logout_uri=https%3A%2F%2Fefmapp.co.uk%2F";
    };
  }
});
</script>

<div class="container-fluid pt-2 pb-2 ps-2 bg-light bg-gradient">
  <h2>Active Flights</h2>
</div>

</body>
</html>
